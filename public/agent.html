<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <!-- The above 3 meta tags *must* come first in the head; any other head content must come *after* these tags -->
  <title>Customer Lookup</title>

  <!-- Bootstrap -->
  <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.6/css/bootstrap.min.css" integrity="sha384-1q8mTJOASx8j1Au+a5WDVnPi2lkFfwwEAa8hDDdjZlpLegxhjVME1fgjWPGmkzs7"
    crossorigin="anonymous">

  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-table/1.10.1/bootstrap-table.min.css">

  <!-- Optional theme -->
  <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.6/css/bootstrap-theme.min.css" integrity="sha384-fLW2N01lMqjakBkx3l/M9EahuwpSfeNvV63J5ezn3uZzapT0u7EYsXMjQV+0En5r"
    crossorigin="anonymous">

  <!-- HTML5 shim and Respond.js for IE8 support of HTML5 elements and media queries -->
  <!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
  <!--[if lt IE 9]>
      <script src="https://oss.maxcdn.com/html5shiv/3.7.2/html5shiv.min.js"></script>
      <script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
    <![endif]-->

  <style>
    #map {
      width: 100%;
      height: 400px;
    }
  </style>

</head>

<body>

  <nav class="navbar navbar-default navbar-inverse navbar-fixed-top" role="navigation">
    <div class="container">
      <div class="navbar-header">
        <button type="button" class="navbar-toggle" data-toggle="collapse" data-target="#navbarCollapse">
          <span class="sr-only">Toggle navigation</span>
          <span class="icon-bar"></span>
          <span class="icon-bar"></span>
          <span class="icon-bar"></span>
        </button>
      </div>
    </div>
  </nav>

  <div class="container">
    <div class="jumbotron">
      <h1 id="title"></h1>
      <p id="about"></p>
    </div>
  </div>

  <div class="container">
    <div class="well" id="agent-response"></div>
    <div class="input-group">
      <span class="input-group-btn">
      <button class="btn btn-default" type="button" id="insurance-query-button" onclick="askQuestion()">
      </button>
      </span>
      <input type="text" class="form-control" id="insurance-query">
    </div>
  </div>

  <div class="container">
    <hr>
  </div>


  <div class="container">
    <div class="row">
      <div class="col-sm-8">

        <div class="panel-group" id="accordion">

          <div class="panel panel-default">
            <div class="panel-heading">
              <h4 class="panel-title">
                <a id="policy-tab" data-toggle="collapse" data-parent="#accordion" href="#policy"></a>
              </h4>
            </div>
            <div id="policy" class="panel-collapse collapse in">
              <div class="panel-body">
                <form>
                  <div class="form-group">
                    <label id="policy-type-message" for="policy-type"></label>
                    <input type="text" class="form-control" id="policy-type" disabled>
                    <label id="numbers-message" for="number-of-policies"></label>
                    <input type="text" class="form-control" id="number-of-policies" disabled>
                    <label id="coverage-message" for="coverage"></label>
                    <input type="text" class="form-control" id="coverage" disabled>
                    <label id="effective-message" for="effective"></label>
                    <input type="text" class="form-control" id="effective" disabled>
                    <label id="inception-message" for="policy-months"></label>
                    <input type="text" class="form-control" id="policy-months" disabled>
                    <label id="monthly-message" for="monthly-premium"></label>
                    <input type="text" class="form-control" id="monthly-premium" disabled>
                  </div>
                </form>
              </div>
            </div>
          </div>

          <div class="panel panel-default">
            <div class="panel-heading">
              <h4 class="panel-title">
                <a id="claims-tab" data-toggle="collapse" data-parent="#accordion" href="#claims"></a>
              </h4>
            </div>
            <div id="claims" class="panel-collapse collapse in">
              <div class="panel-body">
                <form>
                  <div class="form-group">
                    <label id="claim-message" for="months-since-claim"></label>
                    <input type="text" class="form-control" id="months-since-claim" disabled>
                    <label id="claim-reason" for="reason"></label>
                    <input type="text" class="form-control" id="reason" disabled>
                    <label id="claim-amount" for="amount"></label>
                    <input type="text" class="form-control" id="amount" disabled>
                  </div>
                </form>
              </div>
            </div>
          </div>

          <div class="panel panel-default">
            <div class="panel-heading">
              <h4 class="panel-title">
                <a id="offers-tab" data-toggle="collapse" data-parent="#accordion" href="#offers"></a>
              </h4>
            </div>
            <div id="offers" class="panel-collapse collapse in">
              <div class="panel-body">
                <form>
                  <div class="form-group">
                    <label id="offer-message" for="special-offers"></label>
                    <input type="text" class="form-control" id="special-offers" disabled>
                  </div>
                </form>
              </div>
            </div>
          </div>
        </div>
      </div>
      <div class="col-sm-4">
        <div id="map"></div>
      </div>
    </div>

  </div>

  <!-- jQuery (necessary for Bootstrap's JavaScript plugins) -->
  <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.11.3/jquery.min.js"></script>

  <!-- Include all compiled plugins (below), or include individual files as needed -->
  <!-- Latest compiled and minified JavaScript -->
  <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.6/js/bootstrap.min.js" integrity="sha384-0mSbJDEHialfmuBBQP6A4Qrprq5OVfW37PRR3j5ELqxss1yVqOtnepnHVP9aJ7xS"
    crossorigin="anonymous"></script>

  <script src="js/api.js"></script>
  <script src="js/states.json"></script>

  <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyCD6kbd2fgAga9jL-rhuVBAGRA6I04R73E&callback=initMap" async
    defer>
  </script>


  <script>
      function getLatLong(state){
      for(var i = 0; i < stateData.length; i++) {
        if(stateData[i].state == state){
          return {lat: stateData[i].latitude,
                 lng: stateData[i].longitude};
          }
        }
      }

      function initMap() {
        var map = new google.maps.Map(document.getElementById('map'), {
          center: {lat: -34.397, lng: 150.644},
          zoom: 6
        });
        var infoWindow = new google.maps.InfoWindow({map: map});

        // Try HTML5 geolocation.
        if (navigator.geolocation) {
          navigator.geolocation.getCurrentPosition(function(position) {
            var pos = {
              lat: position.coords.latitude,
              lng: position.coords.longitude
            };

            infoWindow.setPosition(pos);
            infoWindow.setContent('Location found.');
            map.setCenter(pos);
          }, function() {
            handleLocationError(true, infoWindow, map.getCenter());
          });
        } else {
          // Browser doesn't support Geolocation
          handleLocationError(false, infoWindow, map.getCenter());
        }
      }

      function handleLocationError(browserHasGeolocation, infoWindow, pos) {
        infoWindow.setPosition(pos);
        infoWindow.setContent(browserHasGeolocation ?
                              'Error: The Geolocation service failed.' :
                              'Error: Your browser doesn\'t support geolocation.');
      }
  </script>


  <script>

      function getCustomer() {
        $.ajax({
          type: "GET",
          url: "https://api.us.apiconnect.ibmcloud.com/atkinusibmcom-dev/production/v1/policy",
          data: {
            "customer":  Api.getResponsePayload().context.policy,
            "client_id": "520dd2ab-feef-41cb-9831-ce69e653af95"
          },
          success: function(data) {

              console.log()
              $("#policy-type").val(data.policyType);
              $("#months-since-claim").val(data.monthsSinceLastClaim);
              $("#number-of-policies").val(data.numberOfPolicies);
              $("#coverage").val(data.coverage);
              $("#effective").val(data.effectiveToDate);
              $("#monthly-premium").val(data.monthlyPremiumAuto);
              $("#policy-months").val(data.monthsSincePolicyInception);
              $("#reason").val(data.claimReason);
              $("#amount").val(data.totalClaimAmount);
              $("#special-offers").val(data.message);  
              var geo = getLatLong(data.state);
              var mapDiv = document.getElementById('map');
              var map = new google.maps.Map(mapDiv, {
                center: {lat: geo.lat, lng: geo.lng},
                zoom: 8
              });
          },
          error: function(xhr) {
              alert(xhr.status);
          }
        });
      }

      function askQuestion() {
        // Retrieve the context from the previous server response
        var context;
        var latestResponse = Api.getResponsePayload();
        if (latestResponse) {
          context = latestResponse.context;
        }

        // Send the user message
        var userLang = navigator.language || navigator.userLanguage;
        Api.sendRequest($("#insurance-query").val(), context, userLang);
        $("#insurance-query").val('');
      }

    </script>

  <script>
      $(document).ready(function () {

        $("#policy.collapse").collapse();
        $("#claims.collapse").collapse();
        $("#offers.collapse").collapse();

        // Call globalization pipeline and load strings
        var instance = "2db863ea6d4653074ca538dc8ef6c0d6";
        var username = "7aeb978446ec9a0e5918b3d746f458ec";
        var password = "i361I9qLOlRZQ7/8n0Z8hY5Czqqf8fZn";
        var base = "https://gp-rest.ng.bluemix.net/translate/rest/";
        var language = navigator.language.substring(0,2);
        var urlPipeline = base + instance + "/v2/bundles/" + "agent/" + language;

        $.ajax({
          type: "GET",
          url: urlPipeline,
          beforeSend: function (xhr) {
            xhr.setRequestHeader ("Authorization", "Basic " + btoa(username + ":" + password));
          },
          success: function(data) {
            $("#title").text(data.resourceStrings.title);
            $("#about").text(data.resourceStrings.about);
            $("#policy-type-message").text(data.resourceStrings.policyType);
            $("#numbers-message").text(data.resourceStrings.numberPolicies);
            $("#monthly-message").text(data.resourceStrings.monthlyPremium);
            $("#claim-message").text(data.resourceStrings.monthsSinceClaim);
            $("#coverage-message").text(data.resourceStrings.coverage);
            $("#effective-message").text(data.resourceStrings.effective);
            $("#inception-message").text(data.resourceStrings.inception);
            $("#insurance-agent").text(data.resourceStrings.insuranceAgent);
            $("#insurance-query-button").text(data.resourceStrings.go);
            $("#claim-reason").text(data.resourceStrings.reason);
            $("#claim-amount").text(data.resourceStrings.amount);
            $("#policy-tab").text(data.resourceStrings.policy);
            $("#claims-tab").text(data.resourceStrings.claims);
            $("#offers-tab").text(data.resourceStrings.offers);
            $("#offer-message").text(data.resourceStrings.offerMessage);
          },
          error: function(xhr) {
              alert(xhr.status);
          }
        });

        var currentResponsePayloadSetter = Api.setResponsePayload;
        Api.setResponsePayload = function(newPayloadStr) {
          currentResponsePayloadSetter.call(Api, newPayloadStr);
          console.log("Received: " + newPayloadStr);
          var data = JSON.parse(newPayloadStr);
          $("#agent-response").text(data.output.text);

          if(data.context.policy && data.context.verified === true) {
            console.log("Getting customer: " + data.context.policy);
            getCustomer();

            // see which accordion panel we should display
            if(data.context.claims) {
              $("#claims.collapse").collapse('show');
            }
            else if(data.context.offers){
              $("#offers.collapse").collapse('show');
            }
            else {
              $("#policy.collapse").collapse('show');
            }
          }

        };

        var userLang = navigator.language || navigator.userLanguage;
        Api.sendRequest('', null, userLang);
      });

    </script>

</body>

</html>